<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Getting started with breakaway • breakaway</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Getting started with breakaway">
<meta property="og:description" content="breakaway">
<meta property="og:image" content="http://adw96.github.io/breakaway/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">breakaway</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">4.7.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/breakaway.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/diversity-hypothesis-testing.html">Introduction to hypothesis testing for diversity</a>
    </li>
    <li>
      <a href="../articles/intro-diversity-estimation.html">Introduction to diversity estimation</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/adw96/breakaway/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="breakaway_files/header-attrs-2.2/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Getting started with breakaway</h1>
                        <h4 class="author">Amy Willis</h4>
            
            <h4 class="date">2020-07-10</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/adw96/breakaway/blob/master/vignettes/breakaway.Rmd"><code>vignettes/breakaway.Rmd</code></a></small>
      <div class="hidden name"><code>breakaway.Rmd</code></div>

    </div>

    
    
<p><code>breakaway</code> is a package for species richness estimation and modelling. As the package has grown and users have requested more functionality, it contains some basic generalisations of the statistical philosophy that underpins <code>breakaway</code> to the general alpha diversity case. Because of the flexibility of the modelling strategies, most users of breakaway are microbial ecologists with very large OTU tables, however, nothing should exclude a macroecologist from using the same tools. If you have a macroecology dataset and want to use this package, I would love to hear from you so please feel free to contact me (email or via Github’s Issues/Projects infrastructure).</p>
<div id="vignette-info" class="section level2">
<h2 class="hasAnchor">
<a href="#vignette-info" class="anchor"></a>Vignette Info</h2>
<p>This vignette will lead you through</p>
<ul>
<li>loading in your data and covariate information</li>
<li>creating frequency tables</li>
<li>using <code>breakaway</code> to estimate species richness</li>
<li>using the objective bayes methods to estimate species richness</li>
<li>estimating various alpha diversity indices and providing a very basic resample-based method for ascribing variability to them</li>
<li>using <code>betta</code> to model changes in alpha diversity with covariates</li>
</ul>
<p>If there is something that you would like explained please feel free to request it!</p>
</div>
<div id="loading-the-package-and-data" class="section level2">
<h2 class="hasAnchor">
<a href="#loading-the-package-and-data" class="anchor"></a>Loading the package and data</h2>
<p>Download the latest version of the package from github.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">breakaway</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">toy_otu_table</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">toy_metadata</span>)

<span class="co">## For historical reasons we're going to call them:</span>
<span class="no">otu_data</span> <span class="kw">&lt;-</span> <span class="no">toy_otu_table</span>
<span class="no">meta_data</span> <span class="kw">&lt;-</span> <span class="no">toy_metadata</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">meta_data</span>)</pre></body></html></div>
<pre><code>##         Years bloom2 Period     Site
## Sample1  2008     no Spring Littoral
## Sample2  2008     no Spring  Pelagic
## Sample3  2008     no Spring  Pelagic
## Sample4  2008     no Summer  Pelagic
## Sample5  2007     no Summer Littoral
## Sample6  2007     no Summer  Pelagic</code></pre>
<p>It is important that the column names of the OTU table is the same as the rownames of the covariate information. Remember to reorder them if they don’t match! You can check this with</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">otu_data</span>) <span class="kw">==</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">meta_data</span>))</pre></body></html></div>
<pre><code>## [1] TRUE TRUE TRUE TRUE TRUE TRUE</code></pre>
</div>
<div id="creating-frequency-tables" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-frequency-tables" class="anchor"></a>Creating frequency tables</h2>
<p>We’re now going to “collapse” the otu_data’s columns (samples) into frequency tables. Frequency tables…</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">frequencytablelist</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/build_frequency_count_tables.html">build_frequency_count_tables</a></span>(<span class="no">otu_data</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">frequencytablelist</span><span class="kw">[[</span><span class="fl">63</span>]])</pre></body></html></div>
<pre><code>##   index frequency
## 1     1        35
## 2     2        22
## 3     3        15
## 4     4        17
## 5     5        11
## 6     6        10</code></pre>
<p>Interpretation: In this sample, there were 57 different species observed only once (singletons), 25 different species observed only twice, …, 1 species observed 171 times.</p>
</div>
<div id="estimating-species-richness" class="section level2">
<h2 class="hasAnchor">
<a href="#estimating-species-richness" class="anchor"></a>Estimating species richness</h2>
<p>Let’s run breakaway on the first frequency count table</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="../reference/breakaway.html">breakaway</a></span>(<span class="no">frequencytablelist</span><span class="kw">[[</span><span class="fl">1</span>]])</pre></body></html></div>
<pre><code>## Estimate of richness from method breakaway:
##   Estimate is 359
##  with standard error 325.81
##   Confidence interval: (258, 18180)</code></pre>
<p>You should get some output to screen, including your estimate &amp; s.e., and a plot of the fits to the ratios. Note that it is not a fit to the frequencies, it is a fit to the ratios of frequencies. You would never need to include this type of plot in one of your papers. It is solely for you to check for model misspecification. What’s model misspecification? If the black diamonds don’t remotely follow the pattern of the white circles, that’s model misspecification.</p>
<p>Sometimes, breakaway’s usual procedure doesn’t work, that is, it gives a negative estimate, which is of course silly. In that case, breakaway returns a different model’s result. It’s called the WLRM. There isn’t a picture. Here is an example of a case where breakaway returns the WLRM.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="../reference/breakaway.html">breakaway</a></span>(<span class="no">frequencytablelist</span><span class="kw">[[</span><span class="fl">60</span>]])</pre></body></html></div>
<pre><code>## Estimate of richness from method breakaway:
##   Estimate is 414
##  with standard error 17.53
##   Confidence interval: (373, 1111)</code></pre>
<p>breakaway can defer to the WLRM for several reasons. Perhaps there are too many singletons. Perhaps there isn’t a long enough tail. Perhaps there is false diversity. In this case, there was probably not enough data. Let’s see if this failure was sensitive to the singleton count by running breakaway_nof1. This requires no singleton count (implicit is that the singleton count was erroneous) and predicts it from the other frequencies.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="../reference/breakaway_nof1.html">breakaway_nof1</a></span>(<span class="no">frequencytablelist</span><span class="kw">[[</span><span class="fl">60</span>]][-<span class="fl">1</span>,])</pre></body></html></div>
<pre><code>## Estimate of richness from method PoissonModel:
##   Estimate is 223
##  with standard error 0.08
##   Confidence interval: (223, 223)</code></pre>
<p>The reference for this method: Willis, A. (2016). Species richness estimation with high diversity but spurious singletons.</p>
<p>breakaway_nof1 is an exploratory tool for assessing sensitivity of breakaway to the singleton count. You should not use it for diversity estimation – only diversity <em>exploration</em> :)</p>
<p>Let’s move on to looking at the Objective Bayes procedures of Kathryn Barger. It’s the latest and greatest in diversity estimation!</p>
<p>There are 4 different types of objective bayes estimates, due to 4 different models. If you have time play with all of them! For now we are just going to look at the negative binomial.</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="co">## Uncomment this at home: just takes a while for compiling</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">2</span>)
<span class="co">#objective_bayes_negbin(frequencytablelist[[1]], plot = F)</span>

<span class="co">### Play with these later</span>
<span class="co">#objective_bayes_poisson(frequencytablelist[[60]])$results</span>
<span class="co">#objective_bayes_geometric(frequencytablelist[[60]])$results</span>
<span class="co">#objective_bayes_mixedgeo(frequencytablelist[[60]])$results</span></pre></body></html></div>
<p>That’s a lot of information! Bayesians are very good at generating a lot of information. This is because rather than a single estimate you see the distribution of estimates (remember that the Bayesian paradigm believes the parameter to be random =&gt; it has a distribution)</p>
<p>Let’s talk about some of the information: $results mode.N/mean.N/median.N : the mode/mean / median estimate $results L/UCI.N: A 95% percent interval estimate for the richness The picture at the bottom: The distribution of estimates</p>
</div>
<div id="estimating-alpha-and-beta-diversity" class="section level2">
<h2 class="hasAnchor">
<a href="#estimating-alpha-and-beta-diversity" class="anchor"></a>Estimating alpha and beta diversity</h2>
<p>The above discussion focused exclusively on richness. Check out <code>github.com/adw96/DivNet</code> for alpha and beta diversity tutorials!</p>
</div>
<div id="modelling-alpha-diversity" class="section level2">
<h2 class="hasAnchor">
<a href="#modelling-alpha-diversity" class="anchor"></a>Modelling alpha diversity</h2>
<p>See the vignette <em>Introduction to hypothesis testing for diversity</em>.</p>
<!-- TODO: Fix this to use DivNet -->
<!-- Let's do some comparisons across samples... accounting for variability of course! -->
<!-- We're going to do this procedure for shannon evenness, and estimate it using the plug-in estimate. This is not meant to imply that you should be interested in Shannon! Just that some people are. -->
<!-- Feel free to substitute in whatever alpha diversity/evenness/richness procedure you're interested in! -->
<!-- To do this we will start by iterating on Shannon on every one of our samples. It may take a minute or two to run. Feel like a stretch? Go ahead! -->
<!-- This section may take a while. Do you know if your neighbour likes bagels? Would they order a croissant over a bagel? Now is a great time to find out! -->
<!-- ```{r} -->
<!-- estimates_shannon <- matrix(NA,nrow=dim(otu_data)[2],ncol=4) -->
<!-- rownames(estimates_shannon) <- colnames(otu_data) -->
<!-- colnames(estimates_shannon) <- c("shannon_est","shannon_seest","shannon_lcb","shannon_ucb") -->
<!-- for (i in 1:dim(otu_data)[2]) { -->
<!--   #resample_estimate(otu_data[,i], shannon, my_sample_size = ns) -->
<!--   samples <- replicate(500, resample_estimate(otu_data[,i], shannon, my_sample_size = ns)) -->
<!--   estimates_shannon[i,1] <- mean(samples) -->
<!--   estimates_shannon[i,2] <- sd(samples) -->
<!--   estimates_shannon[i,3:4] <- quantile(samples, c(0.025, 0.975)) -->
<!-- } -->
<!-- ``` -->
<!-- Here gives us our estimates and standard errors so we can have a look estimates_shannon[,1:2] We can even (normal-ish) plot intervals. The x-axis is just against the enumeration of the lakes. It is not meaningful. -->
<!-- The following plotting command may be different to ones you have seen before. It's a really quick way of visualizing the error in your samples and quickly spotting outliers. NOTE: Outliers have SMALL LINES, which means high precision, and are generally far away from points near them. -->
<!-- ```{r} -->
<!-- betta_pic(estimates_shannon[,1], estimates_shannon[,2]) -->
<!-- ``` -->
<!-- No obvious outliers here. -->
<!-- Lets look at the effect of summer samples -->
<!-- ```{r} -->
<!-- col_by_seasons <- ifelse(meta_data$Period=="Autum","black",ifelse(meta_data$Period=="Spring","pink","red")) -->
<!-- betta_pic(estimates_shannon[,1], estimates_shannon[,2], mycol = col_by_seasons) -->
<!-- legend("bottom",c("Spring","Summer","Autumn"),col=c("pink","red","black"),cex=0.8,lwd=3,box.col=F) -->
<!-- ``` -->
<!-- Don't forget that because we are plotting diversity *estimates*, we need to plot *lines* (i.e. confidence intervals) not points (point estimates). That's very important. -->
<!-- We're now going to create our "design" matrix, a.k.a. "X matrix." To do this we're going to cheat a little. We're going to use an existing R method, lm, to save us the hassle. We are going to investigate the effect of temperature and site -->
<!-- ```{r} -->
<!-- covar_matrix <- model.matrix(lm(rnorm(dim(meta_data)[1])~(meta_data$Site)*(meta_data$Period))) -->
<!-- head(covar_matrix) -->
<!-- colnames(covar_matrix) <- c("Int", "SiteP", "Spring", "Summer", "SitePSpring", "SitePSummer") -->
<!-- ``` -->
<!-- Details (skip if uninterested): lm(y~x+z) is a function that fits a regression line to y using the variables x and z. It has a very nice interface that saves you doing the hard work (aka "math") to create your design matrix. The function we are going to use has no such nice interface. For that reason, we steal the design matrix out of lm()'s implementation. lm(y~x*z) looks at interactions. In this case, we are seeing if the evenness trend as a function of temperature changes depending on the site. -->
<!-- Easter egg: if you can put your own data (from your own research) in the *exact* same form as the above example, you don't need to understand what happens below. You can just copy it :) Hint: The biggest problem you may have in implementing the above is the ordering of the data and the metadata. The following: -->
<!-- ```{r} -->
<!-- colnames(otu_data)==rownames(meta_data) -->
<!-- ``` -->
<!-- being true in every spot is a necessary but not sufficient condition for the following to work properly. -->
<!-- ##MODEL SPECIES RICHNESS, TEST SIGNIFICANCE, INTERPRET RESULTS -->
<!-- Let's go ahead and try to fit our model and take a look at the results -->
<!-- ```{r} -->
<!-- results <- betta(estimates_shannon[,1],estimates_shannon[,2],covar_matrix) -->
<!-- results$table -->
<!-- ``` -->
<!-- Interpretation is idential to regression. -->
<!-- Here are some things to quickly note: -->
<!-- Firstly, significance of Spring means that the average Shannon diversity of the Spring samples is significantly higher than non-Spring AT SITE L. It's more by 0.40 on average. -->
<!-- The non-signif of the SiteP variables means there is no significant difference between Sites P and L, in both summer and not... AFTER ACCOUNTING FOR  ESTIMATION ERROR! -->
<!-- Notice that a regression on the Shannon estimates notes more evidence against the "site has no effect" null: -->
<!-- ```{r} -->
<!-- summary(lm(estimates_shannon[,1] ~ meta_data$Site*(meta_data$Period=="Summ")))$coef[,c(1,4)] -->
<!-- ``` -->
<!-- Not such a big deal in this case, but may be with more, marginal results/more variables. -->
<!-- You should always use betta() when modelling and doing inference on functions of your OTU table! -->
<!-- sigsq_u (in full results output) being significant means there is still *heterogeneity* in the lakes. "Not all lakes have the same Shannon diversity even after accounting for season & site." (microscale heterogeneity, pH, chemical factors, depth...?) -->
<!-- If you are unfamiliar with regression analysis, we would recommend taking an introductory course in regression analysis. You will not regret it (after some period of time)! -->
<!-- Congratulations! You have finished the first tutorial! -->
<!-- An important note: I'm not pushing Shannon. You can repeat all of the above analysis with your own favourite index. Suppose I am more interested in Simpson, or inverse Simpson, or Shannon adjusted for population size. Here is how I would do this: -->
<!-- Define a function to take otu columns and estimate the Simpson index using the plug-in estimate -->
<!-- ```{r} -->
<!-- simpson  <-  function(data) { -->
<!--   data <- data/sum(data) -->
<!--   sum(data^2) -->
<!-- } -->
<!-- ``` -->
<!-- Exercise: define a function to calculate the inverse of the plug-in Simpson index  estimate -->
<!-- To estimate the bootstrap mean and standard error of the simpson index, we do the following -->
<!-- ```{r} -->
<!-- simpson_resamples <- replicate(100, resample_estimate(otu_data[,1], simpson)) -->
<!-- hist(simpson_resamples) -->
<!-- mean(simpson_resamples) -->
<!-- sd(simpson_resamples) -->
<!-- ``` -->
<!-- This is just for the first column. You would do this for every sample (in a loop), then use these as inputs to betta. -->
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Amy Willis, Bryan D Martin, Pauline Trinh, Kathryn Barger, John Bunge.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
