<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Getting started with breakaway • breakaway</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">breakaway</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/breakaway.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/alpha-better.html">alpha diversity, properly</a>
    </li>
    <li>
      <a href="../articles/betta-figure.html">Comparing samples visually with betta</a>
    </li>
    <li>
      <a href="../articles/resample-estimates.html">Variance of alpha diversity estimates</a>
    </li>
    <li>
      <a href="../articles/sample-size-calculations.html">Sample size calculations for alpha diversity</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Getting started with breakaway</h1>
                        <h4 class="author">Amy Willis</h4>
            
            <h4 class="date">2017-10-05</h4>
          </div>

    
    
<div class="contents">
<p><code>breakaway</code> is a package for species richness estimation and modelling. As the package has grown and users have requested more functionality, it contains some basic generalisations of the statistical philosophy that underpins <code>breakaway</code> to the general alpha diversity case. Because of the flexibility of the modelling strategies, most users of breakaway are microbial ecologists with very large OTU tables, however, nothing should exclude a macroecologist from using the same tools. If you have a macroecology dataset and want to use this package, I would love to hear from you so please feel free to contact me (email or via Github’s Issues/Projects infrastructure).</p>
<div id="vignette-info" class="section level2">
<h2 class="hasAnchor">
<a href="#vignette-info" class="anchor"></a>Vignette Info</h2>
<p>This vignette will lead you through</p>
<ul>
<li>loading in your data and covariate information</li>
<li>creating frequency tables</li>
<li>using <code>breakaway</code> to estimate species richness</li>
<li>using the objective bayes methods to estimate species richness</li>
<li>estimating various alpha diversity indices and providing a very basic resample-based method for ascribing variability to them</li>
<li>using <code>betta</code> to model changes in alpha diversity with covariates</li>
</ul>
<p>If there is something that you would like explained please feel free to request it!</p>
</div>
<div id="loading-the-package-and-data" class="section level2">
<h2 class="hasAnchor">
<a href="#loading-the-package-and-data" class="anchor"></a>Loading the package and data</h2>
<p>Download the latest version of the package from github.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">### Run the first two lines at home! ####
<span class="co"># install.packages("devtools")</span>
<span class="co"># devtools::install_github("adw96/breakaway")</span>
<span class="kw">library</span>(breakaway)
<span class="kw">data</span>(toy_otu_table)
<span class="kw">data</span>(toy_metadata)

## For historical reasons we going to call them:
otu_data &lt;-<span class="st"> </span>toy_otu_table
meta_data &lt;-<span class="st"> </span>toy_metadata
<span class="kw">head</span>(meta_data)</code></pre></div>
<pre><code>##         Years bloom2 Period     Site
## Sample1  2008     no Spring Littoral
## Sample2  2008     no Spring  Pelagic
## Sample3  2008     no Spring  Pelagic
## Sample4  2008     no Summer  Pelagic
## Sample5  2007     no Summer Littoral
## Sample6  2007     no Summer  Pelagic</code></pre>
<p>It is important that the column names of the OTU table is the same as the rownames of the covariate information. Remember to reorder them if they don’t match! You can check this with</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(<span class="kw">colnames</span>(otu_data) ==<span class="st"> </span><span class="kw">rownames</span>(meta_data))</code></pre></div>
<pre><code>## [1] TRUE TRUE TRUE TRUE TRUE TRUE</code></pre>
</div>
<div id="creating-frequency-tables" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-frequency-tables" class="anchor"></a>Creating frequency tables</h2>
<p>We’re now going to “collapse” the otu_data’s columns (samples) into frequency tables. Frequency tables…</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">frequencytablelist &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">apply</span>(otu_data,<span class="dv">2</span>,table),as.data.frame)
frequencytablelist &lt;-<span class="st"> </span><span class="kw">lapply</span>(frequencytablelist,function(x) x[x[,<span class="dv">1</span>]!=<span class="dv">0</span>,])
<span class="kw">head</span>(frequencytablelist[[<span class="dv">63</span>]])</code></pre></div>
<pre><code>##   Var1 Freq
## 2    1   35
## 3    2   22
## 4    3   15
## 5    4   17
## 6    5   11
## 7    6   10</code></pre>
<p>Interpretation: In this sample, there were 57 different species observed only once (singletons), 25 different species observed only twice, …, 1 species observed 171 times.</p>
</div>
<div id="estimating-species-richness" class="section level2">
<h2 class="hasAnchor">
<a href="#estimating-species-richness" class="anchor"></a>Estimating species richness</h2>
<p>Let’s run breakaway on the first frequency count table</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/breakaway.html">breakaway</a></span>(frequencytablelist[[<span class="dv">1</span>]])</code></pre></div>
<pre><code>## ################## breakaway ##################
##  The best estimate of total diversity is 359 
##       with std error 326 
##  The model employed was model_1_1 
##  The function selected was
##    f_{x+1}/f_{x} ~ (beta0+beta1*(x-xbar))/(1+alpha1*(x-xbar)) 
##        Coef estimates Coef std errors
## beta0      1.00985054      0.17827684
## beta1      0.10949383      0.06709395
## alpha1     0.08960881      0.09572568
## xbar          8.5</code></pre>
<p>You should get some output to screen, including your estimate &amp; s.e., and a plot of the fits to the ratios. Note that it is not a fit to the frequencies, it is a fit to the ratios of frequencies. You would never need to include this type of plot in one of your papers. It is solely for you to check for model misspecification. What’s model misspecification? If the black diamonds don’t remotely follow the pattern of the white circles, that’s model misspecification.</p>
<p>Sometimes, breakaway’s usual procedure doesn’t work, that is, it gives a negative estimate, which is of course silly. In that case, breakaway returns a different model’s result. It’s called the WLRM. There isn’t a picture. Here is an example of a case where breakaway returns the WLRM.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/breakaway.html">breakaway</a></span>(frequencytablelist[[<span class="dv">60</span>]])</code></pre></div>
<pre><code>## We used 1/x weighting. 
## ################## breakaway ##################
##  The best estimate of total diversity is 414 
##       with std error 18 
##  The model employed was model_1_1 
##  The function selected was
##    f_{x+1}/f_{x} ~ (beta0+beta1*(x-xbar))/(1+alpha1*(x-xbar)) 
##        Coef estimates Coef std errors
## beta0     1.274646798      0.27932103
## beta1     0.031057755      0.08576988
## alpha1   -0.002888851      0.07627283
## xbar          15</code></pre>
<p>breakaway can defer to the WLRM for several reasons. Perhaps there are too many singletons. Perhaps there isn’t a long enough tail. Perhaps there is false diversity. In this case, there was probably not enough data. Let’s see if this failure was sensitive to the singleton count by running breakaway_nof1. This requires no singleton count (implicit is that the singleton count was erroneous) and predicts it from the other frequencies.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/breakaway_nof1.html">breakaway_nof1</a></span>(frequencytablelist[[<span class="dv">60</span>]][-<span class="dv">1</span>,])</code></pre></div>
<pre><code>## No breakaway models converged.################## breakaway ##################
##  The best estimate of total diversity is 358 
##       with std error 10 
##  The model employed was the WLRM</code></pre>
<p>The reference for this method: Willis, A. (2016). Species richness estimation with high diversity but spurious singletons.</p>
<p>breakaway_nof1 is an exploratory tool for assessing sensitivity of breakaway to the singleton count. You should not use it for diversity estimation – only diversity <em>exploration</em> :)</p>
<p>Let’s move on to looking at the Objective Bayes procedures of Kathryn Barger. It’s the latest and greatest in diversity estimation!</p>
<p>There are 4 different types of objective bayes estimates, due to 4 different models. If you have time play with all of them! For now we are just going to look at the negative binomial.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Uncomment this at home: just takes a while for compiling
<span class="kw">set.seed</span>(<span class="dv">2</span>)
<span class="co">#objective_bayes_negbin(frequencytablelist[[1]], plot = F)</span>

### Play with these later
<span class="co">#objective_bayes_poisson(frequencytablelist[[60]])$results</span>
<span class="co">#objective_bayes_geometric(frequencytablelist[[60]])$results</span>
<span class="co">#objective_bayes_mixedgeo(frequencytablelist[[60]])$results</span></code></pre></div>
<p>That’s a lot of information! Bayesians are very good at generating a lot of information. This is because rather than a single estimate you see the distribution of estimates (remember that the Bayesian paradigm believes the parameter to be random =&gt; it has a distribution)</p>
<p>Let’s talk about some of the information: $results mode.N/mean.N/median.N : the mode/mean / median estimate $results L/UCI.N: A 95% percent interval estimate for the richness The picture at the bottom: The distribution of estimates</p>
</div>
<div id="estimating-alpha-diversity" class="section level2">
<h2 class="hasAnchor">
<a href="#estimating-alpha-diversity" class="anchor"></a>Estimating alpha diversity</h2>
<p>The above discussion focused exclusively on richness. Let’s look at the variability of evenness estimates</p>
<p>Let’s calculate the plug in estimate of Shannon diversity</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/shannon.html">shannon</a></span>(frequencytablelist[[<span class="dv">1</span>]])</code></pre></div>
<pre><code>## Warning in Ops.factor(input[, 2], input[, 1]): '*' not meaningful for
## factors</code></pre>
<pre><code>## Warning in Ops.factor(input[, 1], total_reads): '/' not meaningful for
## factors</code></pre>
<pre><code>## [1] NA</code></pre>
<p>4.95, huh? Let’s look at how variable it is</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">2</span>) <span class="co"># the following functions are random, so let's set the seed (allows reproducibility)</span>
<span class="kw"><a href="../reference/resample_estimate.html">resample_estimate</a></span>(otu_data[,<span class="dv">1</span>], shannon)</code></pre></div>
<pre><code>## [1] 4.192225</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/resample_estimate.html">resample_estimate</a></span>(otu_data[,<span class="dv">1</span>], shannon)</code></pre></div>
<pre><code>## [1] 4.195559</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/resample_estimate.html">resample_estimate</a></span>(otu_data[,<span class="dv">1</span>], shannon)</code></pre></div>
<pre><code>## [1] 4.209098</code></pre>
<p>Hmmm, doesn’t look too variable! Let’s look at a lot of them</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))
<span class="kw">hist</span>(<span class="kw">replicate</span>(<span class="dv">200</span>, <span class="kw"><a href="../reference/resample_estimate.html">resample_estimate</a></span>(otu_data[,<span class="dv">1</span>], shannon)))</code></pre></div>
<p><img src="breakaway_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<p>(replicate says: “do this 200 times”) Yikes, that’s some negative skew! That suggests that we have risks in randomly observing really low Shannon diversity estimates. This is an important thing to keep in mind when analysing data. eg. Did we just have bad luck with the sample from the patient taking the drug? Or is the drug causing the effect?</p>
<p>BTW, you can use the above to look sample size variability as well. If you have very different numbers of reads across samples, this can introduce additional variability. Let’s look at the distribution of reads in the current dataset.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ns &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">lapply</span>(frequencytablelist, function(x) <span class="kw">sum</span>(x[,<span class="dv">2</span>])))
<span class="kw">hist</span>(ns)</code></pre></div>
<p><img src="breakaway_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<p>Well, but a lot of variability! Lets account for it in looking at our distribution of Shannon diversity estimates</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">8</span>)
<span class="kw">hist</span>(<span class="kw">replicate</span>(<span class="dv">500</span>, <span class="kw"><a href="../reference/resample_estimate.html">resample_estimate</a></span>(otu_data[,<span class="dv">1</span>], shannon, <span class="dt">my_sample_size =</span> ns)))</code></pre></div>
<p><img src="breakaway_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<p>That’s a lot more variability than we saw originally!</p>
<p>Going forward with your analyses, don’t forget to account for variability in your estimates. Bootstrap standard errors are better than nothing!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sd</span>(<span class="kw">replicate</span>(<span class="dv">500</span>, <span class="kw"><a href="../reference/resample_estimate.html">resample_estimate</a></span>(otu_data[,<span class="dv">1</span>], shannon, <span class="dt">my_sample_size =</span> ns)))</code></pre></div>
<pre><code>## [1] 0.1147657</code></pre>
</div>
<div id="modelling-alpha-diversity" class="section level2">
<h2 class="hasAnchor">
<a href="#modelling-alpha-diversity" class="anchor"></a>Modelling alpha diversity</h2>
<p>We spent a lot of time looking at each sample’salpha diversity values</p>
<p>Let’s do some comparisons across samples… accounting for variability of course!</p>
<p>We’re going to do this procedure for shannon evenness, and estimate it using the plug-in estimate. This is not meant to imply that you should be interested in Shannon! Just that some people are.</p>
<p>Feel free to substitute in whatever alpha diversity/evenness/richness procedure you’re interested in!</p>
<p>To do this we will start by iterating on Shannon on every one of our samples. It may take a minute or two to run. Feel like a stretch? Go ahead!</p>
<p>This section may take a while. Do you know if your neighbour likes bagels? Would they order a croissant over a bagel? Now is a great time to find out!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">estimates_shannon &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>,<span class="dt">nrow=</span><span class="kw">dim</span>(otu_data)[<span class="dv">2</span>],<span class="dt">ncol=</span><span class="dv">4</span>)
<span class="kw">rownames</span>(estimates_shannon) &lt;-<span class="st"> </span><span class="kw">colnames</span>(otu_data)
<span class="kw">colnames</span>(estimates_shannon) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"shannon_est"</span>,<span class="st">"shannon_seest"</span>,<span class="st">"shannon_lcb"</span>,<span class="st">"shannon_ucb"</span>)
for (i in <span class="dv">1</span>:<span class="kw">dim</span>(otu_data)[<span class="dv">2</span>]) {
  <span class="co">#resample_estimate(otu_data[,i], shannon, my_sample_size = ns)</span>
  samples &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">500</span>, <span class="kw"><a href="../reference/resample_estimate.html">resample_estimate</a></span>(otu_data[,i], shannon, <span class="dt">my_sample_size =</span> ns))
  estimates_shannon[i,<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="kw">mean</span>(samples)
  estimates_shannon[i,<span class="dv">2</span>] &lt;-<span class="st"> </span><span class="kw">sd</span>(samples)
  estimates_shannon[i,<span class="dv">3</span>:<span class="dv">4</span>] &lt;-<span class="st"> </span><span class="kw">quantile</span>(samples, <span class="kw">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))
}</code></pre></div>
<p>Here gives us our estimates and standard errors so we can have a look estimates_shannon[,1:2] We can even (normal-ish) plot intervals. The x-axis is just against the enumeration of the lakes. It is not meaningful.</p>
<p>The following plotting command may be different to ones you have seen before. It’s a really quick way of visualizing the error in your samples and quickly spotting outliers. NOTE: Outliers have SMALL LINES, which means high precision, and are generally far away from points near them.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/betta_pic.html">betta_pic</a></span>(estimates_shannon[,<span class="dv">1</span>], estimates_shannon[,<span class="dv">2</span>])</code></pre></div>
<p><img src="breakaway_files/figure-html/unnamed-chunk-15-1.png" width="672"></p>
<p>No obvious outliers here.</p>
<p>Lets look at the effect of summer samples</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">col_by_seasons &lt;-<span class="st"> </span><span class="kw">ifelse</span>(meta_data$Period==<span class="st">"Autum"</span>,<span class="st">"black"</span>,<span class="kw">ifelse</span>(meta_data$Period==<span class="st">"Spring"</span>,<span class="st">"pink"</span>,<span class="st">"red"</span>))
<span class="kw"><a href="../reference/betta_pic.html">betta_pic</a></span>(estimates_shannon[,<span class="dv">1</span>], estimates_shannon[,<span class="dv">2</span>], <span class="dt">mycol =</span> col_by_seasons)
<span class="kw">legend</span>(<span class="st">"bottom"</span>,<span class="kw">c</span>(<span class="st">"Spring"</span>,<span class="st">"Summer"</span>,<span class="st">"Autumn"</span>),<span class="dt">col=</span><span class="kw">c</span>(<span class="st">"pink"</span>,<span class="st">"red"</span>,<span class="st">"black"</span>),<span class="dt">cex=</span><span class="fl">0.8</span>,<span class="dt">lwd=</span><span class="dv">3</span>,<span class="dt">box.col=</span>F)</code></pre></div>
<p><img src="breakaway_files/figure-html/unnamed-chunk-16-1.png" width="672"></p>
<p>Don’t forget that because we are plotting diversity <em>estimates</em>, we need to plot <em>lines</em> (i.e. confidence intervals) not points (point estimates). That’s very important.</p>
<p>We’re now going to create our “design” matrix, a.k.a. “X matrix.” To do this we’re going to cheat a little. We’re going to use an existing R method, lm, to save us the hassle. We are going to investigate the effect of temperature and site</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">covar_matrix &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(<span class="kw">lm</span>(<span class="kw">rnorm</span>(<span class="kw">dim</span>(meta_data)[<span class="dv">1</span>])~(meta_data$Site)*(meta_data$Period)))
<span class="kw">head</span>(covar_matrix)</code></pre></div>
<pre><code>##   (Intercept) meta_data$SitePelagic meta_data$PeriodSpring
## 1           1                     0                      1
## 2           1                     1                      1
## 3           1                     1                      1
## 4           1                     1                      0
## 5           1                     0                      0
## 6           1                     1                      0
##   meta_data$PeriodSummer meta_data$SitePelagic:meta_data$PeriodSpring
## 1                      0                                            0
## 2                      0                                            1
## 3                      0                                            1
## 4                      1                                            0
## 5                      1                                            0
## 6                      1                                            0
##   meta_data$SitePelagic:meta_data$PeriodSummer
## 1                                            0
## 2                                            0
## 3                                            0
## 4                                            1
## 5                                            0
## 6                                            1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">colnames</span>(covar_matrix) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"Int"</span>, <span class="st">"SiteP"</span>, <span class="st">"Spring"</span>, <span class="st">"Summer"</span>, <span class="st">"SitePSpring"</span>, <span class="st">"SitePSummer"</span>)</code></pre></div>
<p>Details (skip if uninterested): lm(y~x+z) is a function that fits a regression line to y using the variables x and z. It has a very nice interface that saves you doing the hard work (aka “math”) to create your design matrix. The function we are going to use has no such nice interface. For that reason, we steal the design matrix out of lm()’s implementation. lm(y~x*z) looks at interactions. In this case, we are seeing if the evenness trend as a function of temperature changes depending on the site.</p>
<p>Easter egg: if you can put your own data (from your own research) in the <em>exact</em> same form as the above example, you don’t need to understand what happens below. You can just copy it :) Hint: The biggest problem you may have in implementing the above is the ordering of the data and the metadata. The following:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">colnames</span>(otu_data)==<span class="kw">rownames</span>(meta_data)</code></pre></div>
<pre><code>##   [1] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE
##  [15] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE
##  [29] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE
##  [43] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE
##  [57] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE
##  [71] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE
##  [85] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE
##  [99] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE
## [113] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE
## [127] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE
## [141] TRUE TRUE TRUE</code></pre>
<p>being true in every spot is a necessary but not sufficient condition for the following to work properly.</p>
</div>
<div id="model-species-richness-test-significance-interpret-results" class="section level2">
<h2 class="hasAnchor">
<a href="#model-species-richness-test-significance-interpret-results" class="anchor"></a>MODEL SPECIES RICHNESS, TEST SIGNIFICANCE, INTERPRET RESULTS</h2>
<p>Let’s go ahead and try to fit our model and take a look at the results</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">results &lt;-<span class="st"> </span><span class="kw"><a href="../reference/betta.html">betta</a></span>(estimates_shannon[,<span class="dv">1</span>],estimates_shannon[,<span class="dv">2</span>],covar_matrix)
results$table</code></pre></div>
<pre><code>##              Estimates Standard Errors p-values
## Int          3.6762282      0.03173672    0.000
## SiteP        0.0703456      0.04539051    0.121
## Spring       0.2799471      0.07531902    0.000
## Summer       0.0000000      0.04006777    1.000
## SitePSpring -0.1624206      0.11361872    0.153
## SitePSummer  0.0000000      0.05733874    1.000</code></pre>
<p>Interpretation is idential to regression.</p>
<p>Here are some things to quickly note: Firstly, significance of Spring means that the average Shannon diversity of the Spring samples is significantly higher than non-Spring AT SITE L. It’s more by 0.40 on average.</p>
<p>The non-signif of the SiteP variables means there is no significant difference between Sites P and L, in both summer and not… AFTER ACCOUNTING FOR ESTIMATION ERROR!</p>
<p>Notice that a regression on the Shannon estimates notes more evidence against the “site has no effect” null:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(<span class="kw">lm</span>(estimates_shannon[,<span class="dv">1</span>] ~<span class="st"> </span>meta_data$Site*(meta_data$Period==<span class="st">"Summ"</span>)))$coef[,<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>)]</code></pre></div>
<pre><code>##                         Estimate      Pr(&gt;|t|)
## (Intercept)           3.73180582 1.416502e-122
## meta_data$SitePelagic 0.03763412  5.525585e-01</code></pre>
<p>Not such a big deal in this case, but may be with more, marginal results/more variables.</p>
<p>You should always use betta() when modelling and doing inference on functions of your OTU table!</p>
<p>sigsq_u (in full results output) being significant means there is still <em>heterogeneity</em> in the lakes. “Not all lakes have the same Shannon diversity even after accounting for season &amp; site.” (microscale heterogeneity, pH, chemical factors, depth…?)</p>
<p>If you are unfamiliar with regression analysis, we would recommend taking an introductory course in regression analysis. You will not regret it (after some period of time)!</p>
<p>Congratulations! You have finished the first tutorial!</p>
<p>An important note: I’m not pushing Shannon. You can repeat all of the above analysis with your own favourite index. Suppose I am more interested in Simpson, or inverse Simpson, or Shannon adjusted for population size. Here is how I would do this:</p>
<p>Define a function to take otu columns and estimate the Simpson index using the plug-in estimate</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">simpson  &lt;-<span class="st">  </span>function(data) {
  data &lt;-<span class="st"> </span>data/<span class="kw">sum</span>(data)
  <span class="kw">sum</span>(data^<span class="dv">2</span>)
}</code></pre></div>
<p>Exercise: define a function to calculate the inverse of the plug-in Simpson index estimate</p>
<p>To estimate the bootstrap mean and standard error of the simpson index, we do the following</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">simpson_resamples &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">100</span>, <span class="kw"><a href="../reference/resample_estimate.html">resample_estimate</a></span>(otu_data[,<span class="dv">1</span>], simpson))
<span class="kw">hist</span>(simpson_resamples)</code></pre></div>
<p><img src="breakaway_files/figure-html/unnamed-chunk-22-1.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(simpson_resamples)</code></pre></div>
<pre><code>## [1] 0.02495933</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sd</span>(simpson_resamples)</code></pre></div>
<pre><code>## [1] 0.002419121</code></pre>
<p>This is just for the first column. You would do this for every sample (in a loop), then use these as inputs to betta.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#vignette-info">Vignette Info</a></li>
      <li><a href="#loading-the-package-and-data">Loading the package and data</a></li>
      <li><a href="#creating-frequency-tables">Creating frequency tables</a></li>
      <li><a href="#estimating-species-richness">Estimating species richness</a></li>
      <li><a href="#estimating-alpha-diversity">Estimating alpha diversity</a></li>
      <li><a href="#modelling-alpha-diversity">Modelling alpha diversity</a></li>
      <li><a href="#model-species-richness-test-significance-interpret-results">MODEL SPECIES RICHNESS, TEST SIGNIFICANCE, INTERPRET RESULTS</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Amy Willis, Kathryn Barger, John Bunge.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
